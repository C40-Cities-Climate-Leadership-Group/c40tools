# c40tools - Complete Package Audit

**Audit date:** 2025-12-16
**Version analysed:** 1.0.1.9000
**Auditor:** AI Agent

---

## Executive Summary

The `c40tools` package is an internal C40 Cities tool providing functionality for:
- Data Warehouse connection
- City data cleaning and validation
- GHG emissions calculations
- Corporate-styled visualisations

**Overall status:** The package is functional but requires significant improvements in infrastructure, testing, and robustness to be considered "production-ready".

---

## 1. INFRASTRUCTURE STATUS

### 1.1 Package Configuration (DESCRIPTION)

| Aspect | Status | Observation |
|--------|--------|-------------|
| Version | ⚠️ | 1.0.1.9000 - Development version without formal release |
| Author email | ❌ | `ptiscornia@turismo.gob.ar` - Not a C40 email |
| Repo URL | ❌ | Points to `ptiscornia/c40tools` instead of C40 organisation |
| Dependencies | ⚠️ | `curl` appears duplicated in Imports |
| `Suggests` | ❌ | Should be `Suggests:` (with final 's') |
| R dependency | ⚠️ | R >= 2.10 is very old (2010) |

**Missing dependency:** `stringdist` - used in `check_city_names.R` but not declared.

### 1.2 Testing

| Aspect | Status |
|--------|--------|
| Testing framework | ❌ Not configured |
| tests/ folder | ❌ Does not exist |
| Coverage | 0% |
| CI/CD | ❌ GitHub Actions mentioned but not implemented |

### 1.3 Documentation

| Aspect | Status |
|--------|--------|
| README.md | ✅ Complete and well structured |
| Roxygen2 | ✅ All functions documented |
| Vignettes | ❌ Do not exist |
| NEWS.md | ⚠️ Exists but very basic |
| CONTRIBUTING.md | ✅ Exists |

### 1.4 Configuration Files

| File | Status | Observation |
|------|--------|-------------|
| .Rbuildignore | ✅ | Well configured |
| .gitignore | ✅ | Adequate |
| NAMESPACE | ✅ | Generated by Roxygen2 |

---

## 2. FUNCTION ANALYSIS

### 2.1 Database Connection Functions

#### `get_dw_connection()` - ⚠️ Needs improvement

**Issues identified:**
1. Does not close connections automatically (potential memory leak)
2. Does not validate connection success
3. Hardcodes `dbname = "postgres"` - should be configurable

**Current code:**
```r
con <- DBI::dbConnect(RPostgres::Redshift(), ...)
return(con)
```

**Recommendation:** Add error handling with `tryCatch()`.

#### `get_c40cities()` - ❌ Critical Issues

**Issues identified:**
1. **Critical bug lines 16-19:** `if(exists("con"))` searches in global environment, which is a dangerous anti-pattern
2. **Connection not closed:** Function opens connection but never closes it
3. **Poorly documented parameter:** Parameter is called `current` but documentation says `year`

```r
# Problem: searches for 'con' in global environment
if(exists("con")){
  con <- con  # This is redundant and dangerous
} else {
  con <- c40tools::get_dw_connection()
}
```

#### `get_dw_db_example()` - ⚠️ Questionable design

- Uses `Sys.sleep(2)` unnecessarily
- Only prints text - could return useful templates

### 2.2 Data Cleaning Functions

#### `clean_text()` - ✅ Well implemented

- Simple and effective
- Handles accents correctly
- Uses `mgsub` appropriately

#### `check_city_names()` - ⚠️ Several issues

**Issues identified:**
1. **Connection not closed** - Memory leak
2. **Modifies input dataframe** directly (side effect)
3. **Hardcodes city mappings** (lines 40-47) - should be in external data
4. **Uses `mutate` without namespace** - should be `dplyr::mutate`

```r
# Problem: Hardcoded mappings
city_stage1 == "ciudad de mexico" ~ "Mexico City",
city_stage1 == "pretoria" ~ "Tshwane",
# ...
```

#### `check_and_correct_cities()` - ⚠️ Multiple issues

**Issues identified:**
1. **Undeclared dependency:** Uses `stringdist::stringdist()` but not in DESCRIPTION
2. **Uses `%>%` and `|>` mixed** - inconsistent
3. **Helper functions not exported but not marked as internal either**

### 2.3 Emissions Calculation Functions

#### `calc_ghg_emissions()` - ⚠️ Complex but functional

**Issues identified:**
1. **Hardcoded SQL of 75+ lines** - difficult to maintain
2. **Incorrect validation lines 61-62:** Error message says "region or tier" but accepts "city" too
3. **Hardcodes specific cities** (lines 162-164):
```r
city %in% c("Dhaka South", "Dhaka North", "Ahmedabad", "Fortaleza") ~ "global south"
```
4. **Unused variable:** `df_city_inventory_emissions` is fetched but only used in one case
5. **Connection closed correctly** ✅

### 2.4 Visualisation Functions

#### `c40_colors()` - ⚠️ Minor issues

**Issues identified:**
1. **Duplicate return** - line 50 is dead code (after another return)
2. **Incorrect validation** - Says "1 to 10" but there are only 6 colours
3. **Typo in documentation:** "avalilable_colors" should be "available_colors"

#### `c40_pallets()` - ✅ Simple and correct

- Works well
- Note: "pallets" should be "palettes" (spelling error)

#### `scale_color_c40()` and `scale_fill_c40()` - ✅ Well implemented

- Correct ggplot2 integration
- Adequate documentation

### 2.5 Utility Functions

#### `round_up()` - ✅ Correct

- Properly vectorised
- Well documented

#### `get_googledrive_path()` - ❌ Critical issues

**Issues identified:**
1. **Only works on macOS** - no validation or alternatives
2. **Assumes specific Google Drive structure**
3. **Typo:** `googe_drive_path` should be `google_drive_path`
4. **Does not handle multiple Google Drive accounts**

#### `add_css()` - ⚠️ Questionable design

1. **Creates files in working directory** - dangerous side effect
2. **Typo:** "baclground-color" instead of "background-color" (4 times)
3. **`file.edit()` opens editor** - not appropriate for programmatic use

### 2.6 Load Hook (zzz.R)

```r
.onLoad <- function(libname, pkgname){
  sysfonts::font_add_google("Roboto", "Roboto")
  sysfonts::font_add_google("Encode Sans", "Encode Sans Normal")
  sysfonts::font_add_google("Fira mono", "monospace")
}
```

**Issue:** Requires internet connection when loading the package. If no internet, may fail silently or with error.

---

## 3. DATASETS

### `df_tiers` - ⚠️ Incomplete documentation

**Issues:**
1. Documentation says "X rows and Y columns" - does not specify actual values
2. Does not describe available columns

---

## 4. NAMESPACE

Internal functions (`find_closest_match`, `check_character_match`) are not marked as such with `@keywords internal`.

---

## 5. IMPROVEMENT PRIORITISATION

### HIGH Priority (Critical for production)

1. **Add `stringdist` to Imports in DESCRIPTION**
2. **Fix the `exists("con")` bug in `get_c40cities()`**
3. **Close DB connections in all functions**
4. **Configure basic testing with testthat**
5. **Correct `Suggest:` to `Suggests:` in DESCRIPTION**
6. **Update repository URLs to C40 organisation**

### MEDIUM Priority (Robustness)

1. **Add GitHub Actions for R CMD check**
2. **Extract hardcoded city mappings to external data**
3. **Add error handling with tryCatch**
4. **Validate platform in `get_googledrive_path()`**
5. **Fix typos (pallets→palettes, googe→google, baclground→background)**
6. **Remove dead code (duplicate returns)**

### LOW Priority (Quality improvements)

1. **Create vignettes with usage examples**
2. **Add more unit tests**
3. **Improve df_tiers documentation**
4. **Consider using pool for DB connections**
5. **Externalise SQL queries to separate files**

---

## 6. ACTION CHECKLIST

- [ ] Update DESCRIPTION:
  - [ ] Change email to C40 domain
  - [ ] Correct repository URL
  - [ ] Add `stringdist` to Imports
  - [ ] Remove duplicate `curl`
  - [ ] Change `Suggest:` to `Suggests:`
  - [ ] Update minimum R version

- [ ] Fix critical bugs:
  - [ ] Remove `exists("con")` in get_c40cities()
  - [ ] Close DB connections in check_city_names()
  - [ ] Correct error message in calc_ghg_emissions()

- [ ] Configure infrastructure:
  - [ ] Create tests/ folder
  - [ ] Add testthat::use_test()
  - [ ] Configure GitHub Actions (.github/workflows/R-CMD-check.yaml)

- [ ] Fix typos:
  - [ ] c40_pallets → c40_palettes (consider deprecation)
  - [ ] googe_drive_path → google_drive_path
  - [ ] baclground-color → background-color (4 places)
  - [ ] avalilable_colors → available_colors

- [ ] Improve robustness:
  - [ ] Add platform validation
  - [ ] Add tryCatch for connections
  - [ ] Externalise city mappings

---

## 7. RECOMMENDED ARCHITECTURE

```
c40tools/
├── R/
│   ├── connection.R         # get_dw_connection, pool management
│   ├── cities.R             # get_c40cities, check_city_names, check_and_correct_cities
│   ├── emissions.R          # calc_ghg_emissions
│   ├── colours.R            # c40_colours, c40_palettes, scales
│   ├── text.R               # clean_text
│   ├── utils.R              # round_up, get_googledrive_path
│   ├── css.R                # add_css
│   └── zzz.R                # .onLoad
├── inst/
│   ├── sql/                 # Externalised SQL queries
│   │   └── ghg_emissions.sql
│   └── extdata/
│       └── city_mappings.csv
├── tests/
│   ├── testthat/
│   │   ├── test-connection.R
│   │   ├── test-cities.R
│   │   └── test-colours.R
│   └── testthat.R
├── vignettes/
│   └── getting-started.Rmd
└── .github/
    └── workflows/
        └── R-CMD-check.yaml
```

---

## 8. CONCLUSION

The `c40tools` package has a solid foundation and useful functionality, but requires significant work before it can be considered "production-ready". The main areas for improvement are:

1. **DB connection management** - Risk of memory leaks
2. **Testing** - Currently 0% coverage
3. **CI/CD** - No automatic validation
4. **Hardcoding** - Too much specific logic embedded in code

With the suggested improvements, the package will be reliably usable in other organisation projects.

---

*Document generated automatically. For updates, run new audit.*
